package recap

import (
	"context"
	"fmt"
	"strings"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
	"github.com/nekomeowww/insights-bot/pkg/bots/tgbot"
	"github.com/nekomeowww/insights-bot/pkg/types/redis"
	"github.com/nekomeowww/insights-bot/pkg/types/telegram"
	"github.com/samber/lo"
	"go.uber.org/zap"
)

func (h *CommandHandler) handleRecapForwardedStartCommand(c *tgbot.Context) (tgbot.Response, error) {
	if !lo.Contains([]telegram.ChatType{telegram.ChatTypePrivate}, telegram.ChatType(c.Update.Message.Chat.Type)) {
		return nil, tgbot.NewMessageError("è¯¥å‘½ä»¤å½“å‰åªèƒ½åœ¨ç§èŠä¸­ä½¿ç”¨å“¦ï¼")
	}

	has, err := h.chathistories.HasOngoingRecapForwardedFromPrivateMessages(c.Update.Message.From.ID)
	if err != nil {
		return nil, err
	}

	if has {
		delCmd := h.redis.B().
			Del().
			Key(redis.RecapReplayFromPrivateMessageBatch1.Format(c.Update.Message.From.ID)).
			Build()

		err := h.redis.Do(context.Background(), delCmd).Error()
		if err != nil {
			return nil, err
		}
	}

	err = h.chathistories.EnabledRecapForwardedFromPrivateMessages(c.Update.Message.From.ID)
	if err != nil {
		return nil, err
	}

	return c.NewMessageReplyTo("æ²¡é—®é¢˜ï¼Œè¯·å°†ä½ éœ€è¦æ€»ç»“çš„æ¶ˆæ¯åœ¨ 2 å°æ—¶å†…å‘ç»™æˆ‘å§ã€‚å‘é€å®Œæ¯•åå¯ä»¥é€šè¿‡å‘é€ /recap_forwarded ç»™æˆ‘æ¥å¼€å§‹æ€»ç»“å“¦ï¼", c.Update.Message.MessageID), nil
}

func (h *CommandHandler) handleRecapForwardedStartShouleCancel(c *tgbot.Context) (bool, error) {
	has, err := h.chathistories.HasOngoingRecapForwardedFromPrivateMessages(c.Update.Message.From.ID)
	if err != nil {
		return false, err
	}

	return has, nil
}

func (h *CommandHandler) handleRecapForwardedStartCancelCommand(c *tgbot.Context) (tgbot.Response, error) {
	err := h.chathistories.DisableRecapForwardedFromPrivateMessages(c.Update.Message.From.ID)
	if err != nil {
		return nil, err
	}

	return c.NewMessageReplyTo("å¥½çš„ï¼Œå·²ç»å¸®ä½ æŠŠæ¶ˆæ¯æ¸…ç†æ‰äº†ï¼Œå¦‚æœéœ€è¦æ€»ç»“è½¬å‘çš„æ¶ˆæ¯ï¼Œå¯ä»¥å†æ¬¡å‘é€ /recap_forwarded_start å¼€å§‹æ“ä½œã€‚", c.Update.Message.MessageID), nil
}

func (h *CommandHandler) handleRecapForwardedCommand(c *tgbot.Context) (tgbot.Response, error) {
	if !lo.Contains([]telegram.ChatType{telegram.ChatTypePrivate}, telegram.ChatType(c.Update.Message.Chat.Type)) {
		return nil, tgbot.NewMessageError("è¯¥å‘½ä»¤å½“å‰åªèƒ½åœ¨ç§èŠä¸­ä½¿ç”¨å“¦ï¼")
	}

	_, err := c.Bot.Send(tgbotapi.NewMessage(
		c.Update.Message.From.ID,
		"æ­£åœ¨ä¸ºå·²ç»æ¥æ”¶åˆ°çš„èŠå¤©è®°å½•ç”Ÿæˆå›é¡¾ï¼Œè¯·ç¨ç­‰...",
	))
	if err != nil {
		h.logger.Error("failed to send message")
	}

	histories, err := h.chathistories.FindPrivateForwardedChatHistories(c.Update.Message.From.ID)
	if err != nil {
		return nil, tgbot.NewExceptionError(err).WithMessage("èŠå¤©è®°å½•å›é¡¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼").WithReply(c.Update.Message)
	}

	if len(histories) < 5 {
		return nil, tgbot.NewMessageError("ç›®å‰æ”¶åˆ°çš„èŠå¤©è®°å½•ä¸è¶³ 5 æ¡å“¦ï¼Œè¦å†å¤šå‘é€ç»™æˆ‘ä¸€äº›ä¹‹åä¹‹åå†è¯•è¯•å—ï¼Ÿ").WithReply(c.Update.Message)
	}

	summarizations, err := h.chathistories.SummarizePrivateForwardedChatHistories(c.Update.Message.From.ID, histories)
	if err != nil {
		return nil, tgbot.NewExceptionError(err).WithMessage("èŠå¤©è®°å½•å›é¡¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼").WithReply(c.Update.Message)
	}

	summarizations = lo.Filter(summarizations, func(item string, _ int) bool { return item != "" })
	if len(summarizations) == 0 {
		return nil, tgbot.NewExceptionError(err).WithMessage("èŠå¤©è®°å½•å›é¡¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼").WithReply(c.Update.Message)
	}

	for i, s := range summarizations {
		summarizations[i] = tgbot.ReplaceMarkdownTitlesToTelegramBoldElement(s)
	}

	summarizationBatches := tgbot.SplitMessagesAgainstLengthLimitIntoMessageGroups(summarizations)

	for i, s := range summarizationBatches {
		var content string
		if len(summarizationBatches) > 1 {
			content = fmt.Sprintf("<blockquote expandable>%s</blockquote>\n\n(%d/%d)\n#recap\n<em>ğŸ¤–ï¸ Generated by chatGPT</em>", strings.Join(s, "\n\n"), i+1, len(summarizationBatches))
		} else {
			content = fmt.Sprintf("<blockquote expandable>%s</blockquote>\n\n#recap\n<em>ğŸ¤–ï¸ Generated by chatGPT</em>", strings.Join(s, "\n\n"))
		}

		msg := tgbotapi.NewMessage(c.Update.Message.Chat.ID, content)
		msg.ParseMode = tgbotapi.ModeHTML
		msg.ReplyToMessageID = c.Update.Message.MessageID

		h.logger.Info("sending chat histories recap for chat",
			zap.Int64("chat_id", c.Update.Message.Chat.ID),
			zap.String("text", msg.Text),
		)

		c.Bot.MaySend(msg)
	}

	msg := tgbotapi.NewMessage(c.Update.Message.Chat.ID, "æ€»ç»“å®Œæˆï¼Œå¦‚æœä½ è§‰å¾—ä¸æ»¡æ„ï¼Œå¯ä»¥å†æ¬¡å‘é€ /recap_forwarded é‡æ–°ç”Ÿæˆå“¦ï¼å¦‚æœè§‰å¾—æ»¡æ„ï¼Œå¹¶ä¸”å¸Œæœ›è¿›è¡Œå…¶ä»–çš„æ€»ç»“æ“ä½œï¼Œå¯ä»¥åœ¨å¼€å§‹å‰å‘é€ /cancel æ¥æ¸…ç©ºå½“å‰å·²ç»æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå¦‚æœä¸è¿›è¡Œæ“ä½œï¼Œç¼“å­˜çš„æ¶ˆæ¯å°†ä¼šåœ¨ 2 å°æ—¶åè¢«è‡ªåŠ¨æ¸…ç†ã€‚")
	msg.ParseMode = tgbotapi.ModeHTML
	msg.ReplyToMessageID = c.Update.Message.MessageID

	return nil, nil
}
